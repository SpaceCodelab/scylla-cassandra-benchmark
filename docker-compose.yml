services:
  # ============================================
  # CASSANDRA CLUSTER (3 nodes)
  # ============================================
  cassandra-1:
    image: cassandra:4.1
    container_name: cassandra-1
    hostname: cassandra-1
    networks:
      - benchmark-network
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_SEEDS=cassandra-1,cassandra-2
      - CASSANDRA_CLUSTER_NAME=CassandraCluster
      - CASSANDRA_DC=dc1
      - CASSANDRA_RACK=rack1
      - MAX_HEAP_SIZE=4G
      - HEAP_NEWSIZE=800M
    volumes:
      - cassandra-1-data:/var/lib/cassandra
    healthcheck:
      test: ["CMD-SHELL", "nodetool status"]
      interval: 30s
      timeout: 10s
      retries: 5
    mem_limit: 6g
    cpus: 2

  cassandra-2:
    image: cassandra:4.1
    container_name: cassandra-2
    hostname: cassandra-2
    networks:
      - benchmark-network
    environment:
      - CASSANDRA_SEEDS=cassandra-1,cassandra-2
      - CASSANDRA_CLUSTER_NAME=CassandraCluster
      - CASSANDRA_DC=dc1
      - CASSANDRA_RACK=rack1
      - MAX_HEAP_SIZE=4G
      - HEAP_NEWSIZE=800M
    volumes:
      - cassandra-2-data:/var/lib/cassandra
    depends_on:
      - cassandra-1
    healthcheck:
      test: ["CMD-SHELL", "nodetool status"]
      interval: 30s
      timeout: 10s
      retries: 5
    mem_limit: 6g
    cpus: 2

  cassandra-3:
    image: cassandra:4.1
    container_name: cassandra-3
    hostname: cassandra-3
    networks:
      - benchmark-network
    environment:
      - CASSANDRA_SEEDS=cassandra-1,cassandra-2
      - CASSANDRA_CLUSTER_NAME=CassandraCluster
      - CASSANDRA_DC=dc1
      - CASSANDRA_RACK=rack1
      - MAX_HEAP_SIZE=4G
      - HEAP_NEWSIZE=800M
    volumes:
      - cassandra-3-data:/var/lib/cassandra
    depends_on:
      - cassandra-1
    healthcheck:
      test: ["CMD-SHELL", "nodetool status"]
      interval: 30s
      timeout: 10s
      retries: 5
    mem_limit: 6g
    cpus: 2

  # ============================================
  # SCYLLADB CLUSTER (3 nodes)
  # ============================================
  scylla-1:
    image: scylladb/scylla:5.4
    container_name: scylla-1
    hostname: scylla-1
    networks:
      - benchmark-network
    ports:
      - "9043:9042"
    command: --seeds=scylla-1,scylla-2 --smp 2 --memory 4G --overprovisioned 1
    volumes:
      - scylla-1-data:/var/lib/scylla
    healthcheck:
      test: ["CMD-SHELL", "nodetool status"]
      interval: 30s
      timeout: 10s
      retries: 5
    mem_limit: 6g
    cpus: 2

  scylla-2:
    image: scylladb/scylla:5.4
    container_name: scylla-2
    hostname: scylla-2
    networks:
      - benchmark-network
    command: --seeds=scylla-1,scylla-2 --smp 2 --memory 4G --overprovisioned 1
    volumes:
      - scylla-2-data:/var/lib/scylla
    depends_on:
      - scylla-1
    healthcheck:
      test: ["CMD-SHELL", "nodetool status"]
      interval: 30s
      timeout: 10s
      retries: 5
    mem_limit: 6g
    cpus: 2

  scylla-3:
    image: scylladb/scylla:5.4
    container_name: scylla-3
    hostname: scylla-3
    networks:
      - benchmark-network
    command: --seeds=scylla-1,scylla-2 --smp 2 --memory 4G --overprovisioned 1
    volumes:
      - scylla-3-data:/var/lib/scylla
    depends_on:
      - scylla-1
    healthcheck:
      test: ["CMD-SHELL", "nodetool status"]
      interval: 30s
      timeout: 10s
      retries: 5
    mem_limit: 6g
    cpus: 2

  # ============================================
  # YCSB CLIENT
  # ============================================
  ycsb:
    build:
      context: ./ycsb
      dockerfile: Dockerfile
    container_name: ycsb-client
    hostname: ycsb-client
    networks:
      - benchmark-network
    volumes:
      - ./results:/results
      - ./scripts:/scripts
    depends_on:
      - cassandra-1
      - scylla-1
    command: tail -f /dev/null
    mem_limit: 4g
    cpus: 2

networks:
  benchmark-network:
    driver: bridge

volumes:
  cassandra-1-data:
  cassandra-2-data:
  cassandra-3-data:
  scylla-1-data:
  scylla-2-data:
  scylla-3-data:
